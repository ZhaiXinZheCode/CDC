# YAF文件格式结构设计规范

## 一、整体结构
YAF(Your Archive Format)是基于**复合数据块(Composite Data Chunk, CDC)** 结构的二进制文件格式。每个CDC包含：

```
[块起始符(CSM)][数据段(DS)][数据段(DS)]...
```

- 文件由**一个或多个CDC块**连续组成
- 每个CDC块以**CSM**开始
- 每个CDC块包含**一个或多个数据段(DS)**
- 数据段分为**文本段(TS)**和**二进制段(BS)**两种类型

## 二、命名规范
| **组件**| 中文命名| 英文命名| 缩写 |
|--------------------|-------------|-----------------------------|------|
| 整体结构| 复合数据块| Composite Data Chunk| CDC|
| 起始标识| 块起始符| Chunk Start Marker| CSM|
| 数据单元| 数据段| Data Segment| DS|
| 文本类型数据段| 文本段| Text Segment| TS|
| 二进制类型数据段| 二进制段| Binary Segment| BS|
| 文本编码字段| 文本编码标识 | Text Encoding Flag| TEF|
| 二进制元数据字段| 保留填充域| Reserved Padding Field| RPF|
| 长度字段| 数据长度声明 | Data Length Declaration| DLD|
| 实际数据内容| 数据负载| Data Payload| DP|

## 三、常量定义
| 常量名| 值| 说明 |
|---------------|-------------|------|
| `CSM`| `b"\xFF"`| 块起始符，标识新CDC块开始 |
| `TS`| `b"\xE0"`| 文本段标记 |
| `BS`| `b"\xEF"`| 二进制段标记 |
| `DS_LIST`| `[b"\xE0", b"\xEF"]` | 有效数据段标记列表 |
| `TEF_SIZE`| `3`| 文本编码标识长度（字节） |
| `RPF_SIZE`| `3`| 保留填充域长度（字节） |
| `RPF`| `b"\x00" * 3` | 保留填充域默认值 |
| `DLD_SIZE`| `8`| 数据长度声明字节数 |
| `DLD_BITODER` | `"big"`| 数据长度声明字节序（大端序） |

## 四、CDC块结构
### 1. 块起始符(CSM)
- 固定值：`0xFF` (1字节)
- 标识新CDC块的开始
- 文件开头必须有CSM
- 多个CDC块时，每个块以CSM开头

### 2. 数据段(DS)
每个数据段由以下四部分组成：
```plaintext
+------+----------------+----------------------+----------------+
| 标记 | 元数据(3字节)| 数据长度声明(8字节)| 数据负载(变长)|
+------+----------------+----------------------+----------------+
│1B│3B│8B│n字节│
```

## 五、数据段类型
### 1. 文本段(TS)
```
+------+--------------+----------------------+----------------+
| 0xE0 | TEF (3字节)| DLD (8字节, 大端序) | 文本数据|
+------+--------------+----------------------+----------------+
```
- **段标记**：固定值 `0xE0` (1字节)
- **文本编码标识(TEF)**：3字节编码标识
- **预定义文本编码**：

| 字节序列 (3字节) | 类型       | 对应编码/格式      | 说明 |
|------------------|------------|-------------------|------|
| **文本编码 (00 XX XX)** | | |
| `00 00 00` | 文本      | UTF-8            | Unicode 标准变长编码 |
| `00 00 01` | 文本      | ASCII            | 基础英文字符集 |
| `00 00 02` | 文本      | GBK              | 简体中文扩展编码 |
| `00 00 03` | 文本      | Big5             | 繁体中文标准编码 |
| `00 00 04` | 文本      | UTF-16 BE        | Unicode 大端序 |
| `00 00 05` | 文本      | UTF-16 LE        | Unicode 小端序 |
| `00 00 06` | 文本      | UTF-32           | Unicode 定长编码 |
| `00 00 07` | 文本      | ISO-8859-1       | 西欧拉丁字母 |
| `00 00 08` | 文本      | Windows-1252     | 西欧扩展 |
| `00 00 09` | 文本      | EUC-JP           | 日文编码 |
| `00 00 0A` | 文本      | Shift_JIS        | 日文传统编码 |
| `00 00 0B` | 文本      | EUC-KR           | 韩文编码 |
| `00 00 0C` | 文本      | ISO-8859-2       | 中欧语言 |
| `00 00 0D` | 文本      | ISO-8859-5       | 西里尔字母 |
| `00 00 0E` | 文本      | ISO-8859-6       | 阿拉伯语 |
| `00 00 0F` | 文本      | ISO-8859-7       | 希腊语 |
| `00 00 10` | 文本      | ISO-8859-8       | 希伯来语 |
| `00 00 11` | 文本      | Windows-1251     | 西里尔字母(俄语) |
| `00 00 12` | 文本      | TIS-620          | 泰语编码 |
| `00 00 13` | 文本      | VISCII           | 越南语编码 |
| `00 00 14` | 文本      | GB18030          | 中文国家标准 |

### 2. 二进制段(BS)
```
+------+---------------------+----------------------+----------------+
| 0xEF | RPF (3字节)| DLD (8字节, 大端序) | 二进制数据|
+------+---------------------+----------------------+----------------+
```

- **段标记**：固定值 `0xEF` (1字节)
- **保留填充域(RPF)**：固定值 `0x000000` (3字节)
- **二进制类型提示**：可通过RPF扩展表示数据类型

| 字节序列 (3字节) | 类型       | 对应编码/格式      | 说明 |
|------------------|------------|-------------------|------|
| **二进制编码 (FF XX XX)** | | |
| `FF 00 01` | 二进制    | JPEG             | 联合图像专家组 |
| `FF 00 02` | 二进制    | PNG              | 便携式网络图形 |
| `FF 00 03` | 二进制    | GIF              | 图形交换格式 |
| `FF 00 04` | 二进制    | WEBP             | 谷歌动态图像 |
| `FF 00 05` | 二进制    | BMP              | Windows位图 |
| `FF 00 06` | 二进制    | TIFF             | 标签图像文件 |
| `FF 00 07` | 二进制    | SVG              | 可缩放矢量图形 |
| `FF 00 08` | 二进制    | HEIC             | 高效图像格式 |
| `FF 00 09` | 二进制    | ZIP              | 通用压缩格式 |
| `FF 00 0A` | 二进制    | GZIP             | GNU压缩格式 |
| `FF 00 0B` | 二进制    | 7Z               | 7-Zip高压缩 |
| `FF 00 0C` | 二进制    | TAR              | Unix归档格式 |
| `FF 00 0D` | 二进制    | RAR              | WinRAR压缩 |
| `FF 00 0E` | 二进制    | PDF              | Adobe文档 |
| `FF 00 0F` | 二进制    | DOCX             | Word文档 |
| `FF 00 10` | 二进制    | XLSX             | Excel文档 |
| `FF 00 11` | 二进制    | PPTX             | PowerPoint文档 |
| `FF 00 12` | 二进制    | EPUB             | 电子书格式 |
| `FF 00 13` | 二进制    | MP3              | MPEG音频层3 |
| `FF 00 14` | 二进制    | FLAC             | 无损音频 |
| `FF 00 15` | 二进制    | WAV              | 波形音频 |
| `FF 00 16` | 二进制    | AAC              | 高级音频编码 |
| `FF 00 17` | 二进制    | OGG              | 开放容器格式 |
| `FF 00 18` | 二进制    | MP4              | MPEG-4视频 |
| `FF 00 19` | 二进制    | AVI              | 音视频交错 |
| `FF 00 1A` | 二进制    | MKV              | Matroska媒体 |
| `FF 00 1B` | 二进制    | WEBM             | 网页媒体 |
| `FF 00 1C` | 二进制    | EXE              | Windows可执行 |
| `FF 00 1D` | 二进制    | ELF              | Unix可执行 |
| `FF 00 1E` | 二进制    | DLL              | 动态链接库 |
| `FF 00 1F` | 二进制    | SQLITE3          | 嵌入式数据库 |
| `FF 00 20` | 二进制    | CSV              | 逗号分隔值 |
| `FF 00 21` | 二进制    | HTML             | 网页文档 |
| `FF 00 22` | 二进制    | XML              | 可扩展标记 |
| `FF 00 23` | 二进制    | JSON             | JavaScript对象 |
| `FF 00 24` | 二进制    | TTF              | TrueType字体 |
| `FF 00 25` | 二进制    | OTF              | OpenType字体 |
| `FF 00 26` | 二进制    | WASM             | WebAssembly |
| `FF 00 27` | 二进制    | CLASS            | Java字节码 |
| `FF 00 28` | 二进制    | DEB              | Debian包 |
| `FF 00 29` | 二进制    | RPM              | Red Hat包 |
| `FF 00 2A` | 二进制    | DMG              | macOS磁盘映像 |

## 六、数据长度声明(DLD)
- **长度**：固定8字节
- **字节序**：大端序(big-endian)
- **取值范围**：0 到 2⁶⁴-1 (16 EB)
- **含义**：声明后续数据负载(DP)的字节长度

## 七、数据负载(DP)
- **文本段**：文本内容，需按TEF指定编码解析
- **二进制段**：原始二进制数据
- **长度**：由DLD字段精确指定

## 八、文件布局示例

```TEXT
文件开始
0x0000: [FF]// CDC块1开始
0x0001: [E0][00 00 00]// 文本段(UTF-8)
[00 00 00 00 00 00 00 0A]// 长度=10字节
[48 65 6C 6C 6F 20 57 6F 72 6C 64] // "Hello World"

0x0016: [EF][00 00 00]// 二进制段
[00 00 00 00 00 00 01 00]// 长度=256字节
[XX XX ... XX]// 256字节二进制数据

0x011E: [FF]// CDC块2开始
...
文件结束
```

